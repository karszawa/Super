# Today's topic

---

# 開発速度と品質を両立しながら開発を行うためにITPチームが何を行っているか

---

## 今日のまとめ

- 巨大なビジネスロジックの制御方法（何を作っているか）
- スクラムの実践方法（どうやって作っているか）

---

## ITPは単一のアプリケーションだが巨大で複雑なビジネスロジックを持っている

ITP（取引画面）は次の条件で振る舞いを変える

- **購入者** か **出品者**
- **取引状態** (WaitShipping / WaitReview / Done, ...)
- **発送方法** (らくらくメルカリ便, ゆうゆうメルカリ便, 大型らくらくメルカリ便, ...)
- **商品カテゴリ** (あんしんスマホサポート, あんしん自動車保証, ...)

---

## ITP（取引画面）の例

![transaction-pages](https://github.com/karszawa/bio/blob/how-to-handle-speed-and-stability/slides/how-to-handle-speed-and-quality/slides/img/transaction-pages.png?raw=true)

<!-- 取引画面の遷移図も書きたい -->

---

## ポイント :bulb:

- ビジネスロジックは画面ごとに異なる
- 共有できるコンポーネントが多くある
- ☞ ビジネスロジックとUIコンポーネントがきれいに分割できるかどうかが重要

<span className="vs-16"></span>

## きれいに分割できると

<span className="vs-16"></span>

- **再利用がしやすい** （開発速度の向上）
- **テストしやすく変更にも強くなる** （品質の向上）

---

## 具体的にはどうやって分ける？

![layers]()

---

## View Layer (React)

「どう見えるか」を定義する層

- マークアップやスタイリングを担当

```js:
const CommentBoxTypeOne = ({
  messages,
  handleMessageChange,
  handleSubmit,
  shouldDisableSendButton,
}) => (
  <div class="block">
    <textarea
      value={message}
      onChange={handleMessageChange}
    />
    {!shouldDisableSendButton && <PrimaryButton onClick={handleSubmit} />}
  </div>
);
```

責務が明確なのでデザインシステムに移行しやすい（移行したとは言っていない）

---

## Display Logic Layer (React-Redux)

「何が見えるか」を定義する層

- 要素の出し分けを行う

```js:
const CommentBox = ({
  shouldDisableSentButton,
  messages,
}) => {
  if (someBranchingLogic) {
    return <CommentBoxTypeOne />;
  }
  return <CommentBoxTypeTwo />;
}

const mapStateToProps = ({ transaction }: Store) => ({
  // ...some display logic
  shouldDisableSentButton,
  messages: someCalculation(transaction.messages),
});;

const mapDispatchToProps = () => ({
  handleMessageChange: updateMessage
});

export default connect(
  mapStateToProps,
  mapDispatchToProps,
)(CommentBox);
```

---

## Connection layer

「振る舞い」を選ぶ層

`connect` でReducerやActionを渡して振る舞いを変更するだけ。
振る舞いの定義自体は次の層で行う。

```
```

---

## Business logic layer by Redux-Saga

「振る舞い」を定義する層

例: 「シンプル」なビジネスロジックの例

1. APIから取引情報を取ってきて保存する
2. データの取得中にはネイティブのローディングアイコンを表示する
3. 取得時にエラーが発生した場合は適切なエラーメッセージを表示する

---

## Business logic layer by Redux & Redux-Saga

```
```

---

## Data layer

Reduxはデータストアとして徹底する

例:

```
```

---

## Data layer

コツ:

- Reducerに複雑なロジックを書かない
- データごとにReducerを分離する

→ シンプルなReducerが無数に存在する状態が理想

---

## ディレクトリベースでレイヤを分割して分割の間違いが起こりにくいようにしている

```
src
├── common
│   └── components
│       ├── Button.tsx
│       ├── Panel.tsx
│       └── Row.tsx
└── transactions
    ├── car
    ├── oogata
    └── rakuraku
        ├── Buyer.tsx
        ├── Seller.tsx
        ├── components
        │   ├── ProductDetail.tsx
        │   └── TransactionInfo.tsx
        ├── containers
        │   ├── Done.tsx
        │   ├── WaitReview.tsx
        │   └── WaitShipping.tsx
        └── stores
            ├── reducers.ts
            └── sagas.ts
```
